import gradio as gr
import os
from dotenv import load_dotenv

# ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ô‡∏µ‡πâ‡πÅ‡∏´‡∏•‡∏∞‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÑ‡∏õ‡∏õ‡∏•‡∏∏‡∏Å‡πÑ‡∏ü‡∏•‡πå .env ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
load_dotenv(override=True)

# ... (‡πÇ‡∏Ñ‡πâ‡∏î LangChain ‡∏≠‡∏∑‡πà‡∏ô‡∏´ ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ) ...

from langchain_groq import ChatGroq
from langchain_huggingface import HuggingFaceEmbeddings
from langchain_community.vectorstores import Chroma
from langchain.chains import create_retrieval_chain
from langchain.chains.combine_documents import create_stuff_documents_chain
from langchain_core.prompts import ChatPromptTemplate

# ================== 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏≠‡∏á AI ‡πÅ‡∏•‡∏∞ RAG Logic ==================
def initialize_system():
    my_key = os.getenv("GROQ_API_KEY")
    print("üîç ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ:", my_key)

    # 2. ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏¢‡∏±‡∏î‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ api_key ‡πÉ‡∏´‡πâ ChatGroq ‡∏ï‡∏£‡∏á‡πÜ ‡πÄ‡∏•‡∏¢
    llm = ChatGroq(
        api_key=my_key,
        model_name="llama-3.3-70b-versatile", 
        temperature=0.2
    )
    # ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Vector DB ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
    embeddings = HuggingFaceEmbeddings(model_name="sentence-transformers/all-MiniLM-L6-v2")
    db = Chroma(persist_directory="./chroma_db", embedding_function=embeddings)
    
    # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á
    retriever = db.as_retriever(search_kwargs={"k": 2})
    
    # System Prompt Design: ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å
    system_prompt = (
        "‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ 'AI Health Buddy' ‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞‡∏ó‡∏µ‡πà‡∏Ñ‡∏≠‡∏¢‡∏î‡∏π‡πÅ‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏\n"
        "‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡∏†‡∏≤‡∏û (Persona): ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏î‡πá‡∏Å‡∏ß‡∏±‡∏¢‡∏£‡∏∏‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏≤ ‡∏ô‡∏¥‡∏™‡∏±‡∏¢‡∏≠‡πà‡∏≠‡∏ô‡πÇ‡∏¢‡∏ô ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡πà‡∏ß‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏¢\n"
        "‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏™‡∏£‡∏£‡∏û‡∏ô‡∏≤‡∏° (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å):\n"
        "- ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ß‡πà‡∏≤ '‡∏Ñ‡∏∏‡∏ì‡∏´‡∏•‡∏≤‡∏ô' ‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î\n"
        "- ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ó‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á (‡∏â‡∏±‡∏ô) ‡∏ß‡πà‡∏≤ '‡∏´‡∏•‡∏≤‡∏ô' ‡∏´‡∏£‡∏∑‡∏≠ '‡∏´‡∏ô‡∏π'\n"
        "- ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏Ñ‡∏∏‡∏ì) ‡∏ß‡πà‡∏≤ '‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏≤/‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏≤‡∏¢' ‡∏´‡∏£‡∏∑‡∏≠ '‡∏Ñ‡∏∏‡∏ì‡∏•‡∏∏‡∏á/‡∏Ñ‡∏∏‡∏ì‡∏õ‡πâ‡∏≤'\n\n"
        "‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö:\n"
        "1. ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏†‡∏≤‡∏û ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢ ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏≤‡∏ô‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà\n"
        "2. ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Context ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏≤‡∏ï‡∏≠‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏î‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤‡πÄ‡∏≠‡∏á\n"
        "3. ‡∏´‡πâ‡∏≤‡∏°‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡πÇ‡∏£‡∏Ñ‡πÄ‡∏≠‡∏á‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á ‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏õ‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå\n\n"
        "Context ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤:\n"
        "{context}\n"
    )
    
    prompt = ChatPromptTemplate.from_messages([
        ("system", system_prompt),
        ("human", "‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: {input}")
    ])
    
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á Chain
    question_answer_chain = create_stuff_documents_chain(llm, prompt)
    rag_chain = create_retrieval_chain(retriever, question_answer_chain)
    
    return rag_chain

qa_chain = initialize_system()

# ================== 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ä‡∏ó ==================
def chat_with_bot(message, history):
    try:
        response = qa_chain.invoke({"input": message})
        return response["answer"]
    except Exception as e:
        return f"‚ùå ‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡∏´‡∏•‡∏≤‡∏ô‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: {e}"

# ================== 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á UI ‡∏î‡πâ‡∏ß‡∏¢ Gradio ==================
demo = gr.ChatInterface(
    fn=chat_with_bot,
    title="ü©∫ AI Health Buddy",
    description="‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏≤‡∏¢ ‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö",
    examples=[
        "‡∏°‡∏µ‡∏¢‡∏≤‡∏≠‡∏∞‡πÑ‡∏£‡∏ä‡πà‡∏ß‡∏¢‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏ö‡πâ‡∏≤‡∏á?",
        "‡∏•‡∏∑‡∏°‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤ ‡∏ó‡∏≥‡∏¢‡∏±‡∏á‡πÑ‡∏á‡∏î‡∏µ?",
        "‡∏¢‡∏≤ Ibuprofen ‡∏Ñ‡∏ô‡πÅ‡∏Å‡πà‡∏Å‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°?"
    ]
    # ‡∏•‡∏ö‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ theme="soft" ‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö
)

if __name__ == "__main__":
    demo.launch(share=False)